{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload & Manage Study Materials</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .card { border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card-header { background: #0d6efd; color: white; border-radius: 12px 12px 0 0; }
        .table thead { background: #0d6efd; color: white; }
        .btn-sm { padding: 3px 8px; font-size: 0.8rem; }
    </style>
</head>
<body>
    <!-- templates/includes/header.html -->
<div class="d-flex justify-content-between align-items-center p-2 bg-light border-bottom">
    <a href="{% url 'teacher-dashboard' %}" class="btn btn-outline-secondary btn-sm">
    <i class="fa fa-arrow-left"></i> Back
</a>
    <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm">
        <i class="fa fa-sign-out-alt"></i> Logout
    </a>
</div>

<div class="container mt-5">

    <!-- Upload Form -->
    <div class="card mb-4">
        <div class="card-header"><h5><i class="fa fa-upload"></i> Upload Study Material</h5></div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Title</label>
                        <input type="text" name="title" class="form-control" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-select" required>
                            <option value="">-- Select Category --</option>
                            <option value="notes">Study Notes</option>
                            <option value="links">Links / Recorded Classes</option>
                            <option value="qp">Previous Question Papers</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Subject</label>
                        <select name="subject" id="subjectSelect" class="form-select" required onchange="updateSemesterBranch()">
                            <option value="">-- Select Subject --</option>
                            {% for subject in subjects %}
                                <option value="{{ subject.id }}" data-semester="{{ subject.semester }}" data-branch="{{ subject.branch }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Semester</label>
                        <input type="text" id="semesterField" class="form-control" readonly>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Branch</label>
                        <input type="text" id="branchField" class="form-control" readonly>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Link (for links category)</label>
                        <input type="url" name="link" class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Upload File</label>
                        <input type="file" name="file" class="form-control">
                    </div>
                </div>

                <div class="mt-3 text-end">
                    <button class="btn btn-primary"><i class="fa fa-upload"></i> Upload</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Uploaded Materials -->
    <div class="card">
        <div class="card-header"><h5><i class="fa fa-list"></i> Uploaded Materials</h5></div>
        <div class="card-body">
            {% if materials %}
                <table class="table table-bordered align-middle">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Subject</th>
                            <th>Semester</th>
                            <th>Branch</th>
                            <th>Uploaded On</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for material in materials %}
                        <tr>
                            <td>{{ material.title }}</td>
                            <td>{{ material.category|title }}</td>
                            <td>{{ material.subject.name }}</td>
                            <td>{{ material.semester }}</td>
                            <td>{{ material.branch }}</td>
                            <td>{{ material.uploaded_at|date:"d M Y" }}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete({{ material.id }})">
                                    <i class="fa fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-center text-muted">No study materials uploaded yet.</p>
            {% endif %}
        </div>
    </div>

</div>

<script>
    function updateSemesterBranch() {
        let subjectSelect = document.getElementById("subjectSelect");
        let semesterField = document.getElementById("semesterField");
        let branchField = document.getElementById("branchField");
        let selectedOption = subjectSelect.options[subjectSelect.selectedIndex];
        semesterField.value = selectedOption.getAttribute("data-semester");
        branchField.value = selectedOption.getAttribute("data-branch");
    }

    function confirmDelete(id) {
        Swal.fire({
            title: 'Are you sure?',
            text: "This material will be permanently deleted!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch("{% url 'delete_study_material' 0 %}".replace("0", id), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                }).then(() => location.reload());
            }
        })
    }
</script>

{% if messages %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% for message in messages %}
    Swal.fire({
        icon: '{% if message.tags == "success" %}success{% elif message.tags == "error" %}error{% elif message.tags == "warning" %}warning{% else %}info{% endif %}',
        title: '{{ message.tags|capfirst }}',
        text: '{{ message|escapejs }}',
        timer: 2000,
        timerProgressBar: true,
        showConfirmButton: false
    });
    {% endfor %}
});
</script>
{% endif %}

</body>
</html>
